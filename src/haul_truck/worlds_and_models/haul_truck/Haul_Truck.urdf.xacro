<?xml version="1.0" ?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="Haul Truck">
  <material name="red">
    <color rgba="0.816 0.157 0.09 1"/>
  </material>
  <material name="black">
    <color rgba="0.043 0.004 0 1"/>
  </material>
  <material name="orange">
    <color rgba="1 0.482 0.251 1" />
  </material>

  <xacro:include filename="$(find start_creating_robots)/worlds_and_models/krytn/inertial.xacro" />

  <xacro:macro name="wheel" params="name">
    <link name="${name}">
      <visual>
        <!--Wheel/Body001.-->
        <origin xyz="0.0 0.0 0.0" rpy="0.0 -0.0 0.0"/>
        <geometry>
          <mesh filename="file://$(find haul_truck)/worlds_and_models/haul_truck/meshes/safeai_Body001.dae"/>
        </geometry>
        <material name="black" />
      </visual>
      <collision>
        <!--Wheel/Body001.-->
        <origin xyz="0.0 0.0 0.0" rpy="0.0 -0.0 0.0"/>
        <geometry>
          <mesh filename="file://$(find haul_truck)/worlds_and_models/haul_truck/meshes/safeai_Pad012.dae"/>
        </geometry>
        <mu>1.0</mu>
        <mu2>1.0</mu2>
        <fdir1>0 0 1</fdir1>
        <slip1>1.0</slip1>
        <slip2>1.0</slip2>
        <min_depth>0.5</min_depth>
        <kp>1e8</kp>

      </collision>
      <xacro:sphere_inertial radius="1" mass="0.2" />
    </link>


  </xacro:macro>

  <link name="base_footprint" />

  <joint name="chassis_joint" type="fixed">
    <parent link="base_footprint" />
    <child link="chassis_link" />
    <origin rpy="0 0 1.5705" />
  </joint>

  <!--Generated by CROSS, a ROS Workbench for FreeCAD (https://github.com/galou/freecad.cross)-->
  <link name="chassis_link">
    <visual>
      <!--Chassis/Body.-->
      <origin xyz="0.0 0.0 0.0" rpy="0.0 -0.0 0.0"/>
      <geometry>
        <mesh filename="file://$(find haul_truck)/worlds_and_models/haul_truck/meshes/safeai_Body.dae"/>
      </geometry>

    </visual>
    <collision>
      <!--real_chassis_link_.Body_bbox-->
      <origin xyz="0.090073 5.25 3.35026" rpy="0.0 -0.0 0.0"/>
      <geometry>
        <box size="7.6383887394832115 10.500000000000005 1.84423459552541"/>
      </geometry>
      <gazebo>
        <mu>0.1</mu>
      </gazebo>
    </collision>
    <xacro:box_inertial_with_origin x="8" y="10" z="3" mass="100">
      <origin xyz="0 5 0" rpy="0 0 0" />
    </xacro:box_inertial_with_origin>
  </link>
  <link name="tray_link">
    <visual>
      <!--Tray/Body002.-->
      <origin xyz="0.0 0.0 0.0" rpy="0.0 -0.0 0.0"/>
      <geometry>
        <mesh filename="file://$(find haul_truck)/worlds_and_models/haul_truck/meshes/Unnamed_Body002.dae"/>
      </geometry>
      <material name="red" />
    </visual>
    <collision>
      <!--Tray/Body002.-->
      <origin xyz="0.0 0.0 0.0" rpy="0.0 -0.0 0.0"/>
      <geometry>
        <mesh filename="file://$(find haul_truck)/worlds_and_models/haul_truck/meshes/Unnamed_Body002.dae"/>
      </geometry>
    </collision>
    <!-- 
    <collision>
      <origin xyz="3.5 7 0 " rpy="0.0 -0.0 0.0"/>
      <geometry>
        <box size="7.638000000000004 13.858283829000012 1.4610417480000075"/>
      </geometry>
      <gazebo>
        <mu>0.1</mu>
      </gazebo>
    </collision>
    <xacro:box_inertial_with_origin x="8" y="10" z="1" mass="1">
      <origin xyz="0 -5 0" rpy="0 0 0" />
    </xacro:box_inertial_with_origin>
  -->
  </link>
  <xacro:wheel name="front_left_wheel_link" />
  <xacro:wheel name="front_right_wheel_link" />
  <xacro:wheel name="rear_left_wheel_link" />
  <xacro:wheel name="rear_right_wheel_link" />



  <joint name="tray_joint" type="fixed">
    <parent link="chassis_link"/>
    <child link="tray_link"/>
    <origin xyz="-3.8 1.0 3.1" rpy="0.0 -0.0 0.0"/>
  </joint>

  <xacro:if value="True">
    <link name="front_left_steering_link">
      <xacro:box_inertial x="0.1" y="1" z="0.1" mass="1"/>
    </link>
    <link name="front_right_steering_link">
      <xacro:box_inertial x="0.1" y="1" z="0.1" mass="1"/>
    </link>
    <joint name="front_left_steering_joint" type="revolute">
      <parent link="chassis_link" />
      <child link="front_left_steering_link" />
      <axis xyz="0 0 1"/>
      <origin xyz="2.8 3.2 0.6" rpy="0.0 -0.0 0.0"/>
      <limit lower="-0.4" upper="0.4" effort="10000000" velocity="1000.00"/>

    </joint>
    <joint name="front_right_steering_joint" type="revolute">
      <parent link="chassis_link" />
      <child link="front_right_steering_link" />
      <origin xyz="-4.0 3.2 0.6" rpy="0.0 -0.0 0.0"/>
      <axis xyz="0 0 1"/>
      <limit lower="-0.4" upper="0.4" effort="10000000" velocity="1000.00"/>
    </joint>


    <joint name="front_left_wheel_joint" type="continuous">
      <parent link="front_left_steering_link"/>
      <child link="front_left_wheel_link"/>
      <axis xyz="1 0 0"/>
    </joint>
    <joint name="front_right_wheel_joint" type="continuous">
      <parent link="front_right_steering_link"/>
      <child link="front_right_wheel_link"/>
      <axis xyz="1 0 0"/>
    </joint>

  </xacro:if>

  <xacro:if value="False">


    <joint name="front_left_wheel_joint" type="continuous">
      <parent link="chassis_link"/>
      <child link="front_left_wheel_link"/>
      <origin xyz="2.8 3.2 0.6" rpy="0.0 -0.0 0.0"/>
      <limit effort="10000000" velocity="1000.00" stiffness="0" dissipation="0"/>

      <axis xyz="1 0 0"/>
    </joint>
    <joint name="front_right_wheel_joint" type="continuous">
      <parent link="chassis_link"/>
      <child link="front_right_wheel_link"/>
      <origin xyz="-4.0 3.2 0.6" rpy="0.0 -0.0 0.0"/>
      <limit effort="10000000" velocity="1000.00" stiffness="0" dissipation="0"/>

      <axis xyz="1 0 0"/>
    </joint>
  </xacro:if>

  <joint name="rear_left_wheel_joint" type="continuous">
    <parent link="chassis_link"/>
    <child link="rear_left_wheel_link"/>
    <origin xyz="2.8 9.3 0.6" rpy="0.0 -0.0 0.0"/>
    <axis xyz="1 0 0"/>
    <limit effort="10000000" velocity="1000.00"/>

  </joint>
  <joint name="rear_right_wheel_joint" type="continuous">
    <parent link="chassis_link"/>
    <child link="rear_right_wheel_link"/>
    <origin xyz="-4.0 9.3 0.6" rpy="0.0 -0.0 0.0"/>
    <axis xyz="1 0 0"/>
    <limit effort="10000000" velocity="1000.00"/>
  </joint>

  <xacro:include filename="$(find haul_truck)/worlds_and_models/haul_truck/lidar_3d_v1.urdf.xacro" />

  <gazebo>
    <plugin filename="ignition-gazebo-sensors-system" name="ignition::gazebo::systems::Sensors">
      <render_engine>ogre2</render_engine>
    </plugin>



  </gazebo>



  <ros2_control name="GazeboSystem" type="system">
    <hardware>
      <plugin>ign_ros2_control/IgnitionSystem</plugin>
    </hardware>
    <xacro:if value="True">
      <joint name="front_left_steering_joint">
        <command_interface name="position">
          <param name="min">-0.2</param>
          <param name="max">0.2</param>
        </command_interface>
        <state_interface name="position"/>
      </joint>
      <joint name="front_right_steering_joint">
        <command_interface name="position">
          <param name="min">-0.2</param>
          <param name="max">0.2</param>
        </command_interface>
        <state_interface name="position"/>
      </joint>
      <!-- Adding front wheel state interfaces so that their position is given to ros -->
      <joint name="front_left_wheel_joint">
        <command_interface name="velocity">
          <param name="min">-1</param>
          <param name="max">1</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
      <joint name="front_right_wheel_joint">
        <command_interface name="velocity">
          <param name="min">-1</param>
          <param name="max">1</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
    </xacro:if>
    <xacro:if value="False">
      <joint name="front_left_wheel_joint">
        <command_interface name="velocity">
          <param name="min">-1</param>
          <param name="max">1</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
      <joint name="front_right_wheel_joint">
        <command_interface name="velocity">
          <param name="min">-1</param>
          <param name="max">1</param>
        </command_interface>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
    </xacro:if>
    <joint name="rear_left_wheel_joint">
      <command_interface name="velocity">
        <param name="min">-1</param>
        <param name="max">1</param>
      </command_interface>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
    <joint name="rear_right_wheel_joint">
      <command_interface name="velocity">
        <param name="min">-1</param>
        <param name="max">1</param>
      </command_interface>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>

  </ros2_control>


  <gazebo>
    <plugin filename="ign_ros2_control-system" name="ign_ros2_control::IgnitionROS2ControlPlugin">

      <ros>
        <remapping>/ackermann_steering_controller/odometry:=odom</remapping>
        <remapping>/ackermann_steering_controller/tf_odometry:=tf</remapping>
        <remapping>/ackermann_steering_controller/reference_unstamped:=cmd_vel</remapping>
      </ros>
      <parameters>$(find haul_truck)/config/ackermann_control.yaml</parameters>
      <!-- Remapping topics so that mapping system works! -->

    </plugin>
  </gazebo>


</robot>
